---
title: "#TidyTuesday week-05"
author: "Brendi Ang"
date: "01/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggimage)
library(janitor)
library(patchwork)
library(showtext)
```

```{r, include=FALSE}
# Read-in data
breed_traits <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/breed_traits.csv') 
trait_description <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/trait_description.csv')
breed_rank <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-02-01/breed_rank.csv')
```

## Data wrangling

```{r}
# --- Clean data

breed_traits <- breed_traits %>% 
  janitor::clean_names() %>% 
  # Remove repeated white space inside string
  mutate(breed = str_squish(breed)) 

trait_description <- trait_description %>% 
  janitor::clean_names()

# Rename year columns to rank_2013, rank_2014, ... 
breed_rank <- breed_rank %>% 
  janitor::clean_names() %>%
  rename_with(.cols = matches("^x"),
              .fn = ~ str_replace(.,
                                  pattern = "x(\\d+)_(rank)",
                                  replacement = "\\2_\\1"))
```

```{r}
# Select certain traits
terrier_traits <- breed_traits %>%  
  filter(str_detect(breed, regex("terrier", ignore_case = TRUE))) %>% 
  select(
    breed,
    affectionate_with_family,
    good_with_young_children,
    good_with_other_dogs,
    openness_to_strangers
  )

# Modify (shorten) names of traits
terrier_traits <- terrier_traits %>% 
  rename("Affectionate" = affectionate_with_family, 
         "Child-friendly" = good_with_young_children,
         "Dog-friendly" = good_with_other_dogs,
         "Personable" = openness_to_strangers)

# Select top 11 terrier breeds (including Westie)
terrier_rank <- breed_rank %>%
  select(breed, rank_2020, image) %>% 
  filter(str_detect(breed, regex("terrier", ignore_case = TRUE))) %>% 
  slice_min(rank_2020, n = 11) %>% 
  select(-rank_2020)

# Include image URL 
terrier_traits <- terrier_traits %>% 
  filter(breed %in% unique(terrier_rank$breed)) %>% 
  left_join(terrier_rank, by = "breed") 
```

## Prepare dataset for plotting

```{r}
# Long format for plotting
terrier_traits_long <- terrier_traits %>% 
  pivot_longer(cols = Affectionate:Personable,
               names_to = "trait",
               values_to = "rating") %>% 
  mutate(trait = factor(trait)) %>% 
  relocate(image, .after = rating)
```

```{r}
# Read-in bones images
bones <- tibble(trait = unique(terrier_traits_long$trait),
                bone = paste0(here::here("2022/week-05/images/"), "bone-", c(1:4), ".png"))

terrier_traits_long <- terrier_traits_long %>% 
  left_join(bones, by = "trait")
```

```{r}
# Create id column for each trait 
terrier_traits_long <- terrier_traits_long %>% 
  group_by(breed) %>% 
  mutate(id = row_number()) %>% 
  ungroup()

# Replicate rows based on each trait's rating
terrier_traits_long <- terrier_traits_long %>%  
  group_by(breed,trait) %>% 
  slice(rep(1:n(), each = rating)) %>% 
  ungroup()  

# Create a second id to show total no. of bones for each trait's rating
terrier_traits_long <- terrier_traits_long %>% 
  group_by(breed) %>% 
  mutate(id2 = seq(from = 0, by = 0.22, length.out = n()))
```

```{r}
# Create data to plot geom_segment
df <- tibble(y = seq(from = 1, to = 4, by = 1))
```

```{r}
# Create fill variable for the plot's legend
terrier_traits_long <- terrier_traits_long %>% 
  mutate(fill = case_when(
    trait == "Affectionate" ~ "#c04b3f",
    trait == "Child-friendly" ~ "#93ac68",
    trait == "Dog-friendly" ~ "#9c53a8",
    trait == "Personable" ~ "#b78e3e",
  ))
```

## Plotting 

```{r, message=FALSE}
library(showtext)
sysfonts::font_add_google(name = "Dancing Script", family = "Bold 700")
sysfonts::font_add_google(name = "EB Garamond", family = "Medium 500")
sysfonts::font_add_google(name = "Domine", family = "Semi-bold 600")
showtext_opts(dpi = 120)
showtext_auto(enable = TRUE)
```

```{r}
# Create plot for each breed (no trait name)
plot_terrier <- function(breed){

  # Filter to specific breed
  terrier_traits_long <- terrier_traits_long %>% filter(breed == {{breed}})
  
  # --- Plot
  terrier_traits_long %>%
    ggplot() +
    # Base layer
    geom_segment(data = df, aes(x = 0, xend = 4, y = y, yend = y), colour = "white") +
    # No. of bones relating to ratings
    geom_image(aes(x = id + id2, y = 4, image = bone), size = 0.15, nudge_x = 0.5) +
    # Dog breed
    geom_image(aes(x = 0, y = 0, image = image), size = 0.5) +
    # Dog breed name
    geom_text(data = distinct(terrier_traits_long, breed), aes(x = -0.2, y = 0, label = {{breed}}), vjust = -7,
              family = "Bold 700", size = 5) +
    coord_polar() +
    theme_void() 
}
```

```{r}
# Create main plot (includes legend)

plot_terrier_main <- function(breed){

  # Filter to specific breed
  terrier_traits_long <- terrier_traits_long %>% filter(breed == {{breed}})
  
  # --- Plot
  terrier_traits_long %>%
    ggplot() +
    # Base layer
    geom_segment(data = df, aes(x = 0, xend = 4, y = y, yend = y), colour = "white") +
    # Facilitate manually plotting legend (won't be shown in plot)
    geom_tile(data = distinct(terrier_traits_long, trait), aes(x = 0, y = 0, fill = trait)) +
    # No. of bones relating to ratings
    geom_image(aes(x = id + id2, y = 4, image = bone), size = 0.15, nudge_x = 0.5) +
    # Dog breed
    geom_image(aes(x = 0, y = 0, image = image), size = 0.5) +
    # Dog breed name
    geom_text(data = distinct(terrier_traits_long, breed), aes(x = -0.2, y = 0, label = {{breed}}), vjust = -7.5,
              family = "Bold 700", size = 9) +
    coord_polar() +
    theme_void() +
    # Themes, scales etc.
    scale_fill_manual(name = "Trait",
                      values = c("Affectionate" = "#c04b3f",
                                 "Child-friendly" = "#93ac68",
                                 "Dog-friendly" = "#9c53a8",
                                 "Personable" = "#b78e3e")) +
    theme(legend.position = "bottom")
}
```


```{r}
# Plot top 10 dogs (excluding Westies)
top_10 <- terrier_traits_long %>% filter(breed != "West Highland White Terriers")

# Arrange top 10 dogs by rank
top_10 <- breed_rank %>% 
  select(breed, rank_2020) %>% 
  right_join(top_10, by = "breed") %>% 
  arrange(rank_2020)

# Save all plots as a list
p <- purrr::map(.x = unique(top_10$breed), .f = plot_terrier)
```

```{r}
# Main plot
main <- plot_terrier_main("West Highland White Terriers")
```

```{r}
library(patchwork)

layout <- "
AABCD
AAEFG
AAHIJ
" 

# Add layout
pp <- main + p[[1]] + p[[2]] + p[[3]] + p[[4]] + p[[5]] + p[[6]] + p[[7]] + p[[8]] + p[[9]] +
  plot_layout(design = layout, guides = "collect") & theme(legend.position = "bottom")

# Add Annotations
pp <- pp + plot_annotation(title = "Are Terriers great companions?",
                           subtitle = "Ratings are based on a scale of 1 (low) to 5 (high) bones",
                           caption = "Source: American Kennel Club, courtesy of @KKakey | #TidyTuesday 2022 week 5")

# Add themes
pp & theme(
  legend.text = element_text(size = 12, family = "Medium 500"),
  legend.title = element_text(size = 18, family = "Medium 500", face = "bold.italic"),
  plot.title = element_text(family = "Semi-bold 600", size = 33, vjust = -25, hjust = 0.02, face = "bold"),
  plot.subtitle = element_text(family = "Semi-bold 600", size = 15, vjust = -55, hjust = 0.07),
  plot.caption = element_text(size = 15, family = "Medium 500")
  )
```

```{r}
ggsave("week-05-plot.png", width = 8, height = 6, units = "in")
```



